const { createBot, createProvider, createFlow, addKeyword } = require('@bot-whatsapp/bot')

const QRPortalWeb = require('@bot-whatsapp/portal')
const BaileysProvider = require('@bot-whatsapp/provider/baileys')
const MockAdapter = require('@bot-whatsapp/database/mock')

// FLUJO PARA RESPUESTAS NO ENTENDIDAS
const flowDefault = addKeyword('')
    .addAnswer([
        'ü§ñ *Disculpa, no entend√≠ tu mensaje*',
        '',
        'Opciones v√°lidas:',
        'üëâ *1*, *2*, *3* - Elegir destino',
        'üëâ *informaci√≥n* - Sobre nuestra agencia',
        'üëâ *reservar* - Iniciar reservaci√≥n',
        'üëâ *hola* - Volver al inicio'
    ])

// FLUJO DE RESERVAS
const flowReservar = addKeyword(['reservar', 'reserva'])
    .addAnswer([
        'üìÖ *¬°Perfecto!* Vamos a crear tu reserva:',
        '',
        'Necesitamos:',
        '1. üìù Nombre completo',
        '2. üë• N√∫mero de personas',
        '3. üìÖ Fechas deseadas',
        '4. üèñ Destino elegido',
        '',
        'Un asesor te contactar√° pronto para confirmar ‚ú®'
    ])

// INFORMACI√ìN GENERAL DE LA AGENCIA
const flowInfoAgencia = addKeyword(['informaci√≥n', 'info', 'agencia'])
    .addAnswer([
        'üåü *Somos una agencia con m√°s de 25 a√±os de trayectoria* üåü',
        '',
        '‚ú® *Paquetes Full Day con todo incluido:*',
        '- üöå Bus con aire acondicionado',
        '- üçΩ 3 comidas diarias',
        '- ‚õµ Lanchas a playas paradis√≠acas',
        '- üè® Habitaciones privadas',
        '- üïí Asistencia 24/7',
        '- üí≥ Facilidades de pago',
        '',
        'Escribe el *n√∫mero* de tu destino favorito para ver detalles:',
        '1Ô∏è‚É£ Chichiriviche',
        '2Ô∏è‚É£ Mochima',
        '3Ô∏è‚É£ Tucacas'
    ])

// Funci√≥n para filtrar fechas por mes
const filtrarFechasPorMes = (fechas, mes) => {
    const meses = {
        'enero': 'ENE', 'febrero': 'FEB', 'marzo': 'MAR', 'abril': 'ABR',
        'mayo': 'MAYO', 'junio': 'JUN', 'julio': 'JUL', 'agosto': 'AGO',
        'septiembre': 'SEP', 'octubre': 'OCT', 'noviembre': 'NOV', 'diciembre': 'DIC'
    };
    
    const mesBusqueda = meses[mes.toLowerCase()];
    if (!mesBusqueda) return [];
    
    return fechas.filter(fecha => fecha.includes(mesBusqueda));
}

// FLUJO PARA MANEJAR LA SELECCI√ìN DE MES
const flowMes = addKeyword(['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'])
    .addAction(
        async (ctx, { flowDynamic, state }) => {
            const mes = ctx.body.toLowerCase();
            const { destino } = await state.getMyState();
            
            // Fechas completas para cada destino
            const fechasChichiriviche = [
                '‚úì DEL 15 AL 19 MAYO 2025 (4D/3N CELEBRACI√ìN DE LAS MADRES)',
                '‚úì DEL 21 AL 25 MAYO 2025 (4D/3N PAQUETE LUISANA BOGOT√Å)',
                '‚úì DEL 05 AL 08 JUN 2025 (PROMO 3D/2N)',
                '‚úì DEL 26 AL 29 JUN 2025 (PROMO 3D/2N)',
                '‚úì DEL 19 AL 22 JUN 2025 (OCUMARE 3D/2N)',
                '‚úì DEL 03 AL 06 JUL 2025 (PROMO 3D/2N)',
                '‚úì DEL 17 AL 20 JUL 2025 (PROMO 3D/2N)',
                '‚úì DEL 20 AL 24 JUL 2025 (4D/3N)',
                '‚úì DEL 31 JUL AL 04 AGO 2025 (4D/3N)',
                '‚úì DEL 04 AL 08 AGO 2025 (4D/3N)',
                '‚úì DEL 08 AL 12 AGO 2025 (4D/3N)',
                '‚úì DEL 12 AL 15 AGO 2025 (PROMO 3D/2N)',
                '‚úì DEL 15 AL 19 AGO 2025 (4D/3N)',
                '‚úì DEL 29 AGO AL 02 SEP 2025 (4D/3N)',
                '‚úì DEL 12 AL 15 SEP 2025 (PROMO 3D/2N)',
                '‚úì DEL 16 AL 19 SEP 2025 (PROMO 3D/2N)',
                '‚úì DEL 19 AL 23 SEP 2025 (4D/3N)',
                '‚úì DEL 25 AL 28 SEP 2025 (PROMO 3D/2N)',
                '‚úì DEL 02 AL 05 OCT 2025 (PROMO 3D/2N)',
                '‚úì DEL 30 OCT AL 02 NOV 2025 (PROMO 3D/2N)',
                '‚úì DEL 06 AL 09 NOV 2025 (PROMO 3D/2N)',
                '‚úì DEL 27 AL 30 NOV 2025 (PROMO 3D/2N)',
                '‚úì DEL 11 AL 14 DIC 2025 (PROMO 3D/2N)',
                '‚úì DEL 22 AL 26 DIC 2025 (4D/3N)',
                '‚úì DEL 29 DIC AL 02 ENE 2026 (4D/3N)',
                '‚úì DEL 03 AL 07 ENE 2026 (4D/3N)'
            ];
            
            const fechasMochima = [
                '‚úì DEL 21 AL 27 AGO 2025 (5 D√çAS)',
                '‚úì DEL 05 AL 11 SEP 2025 (5 D√çAS)',
                '‚úì DEL 02 AL 08 ENE 2026 (5 D√çAS)'
            ];

            const fechasTucacas = [
                '‚úì Pr√≥ximas fechas en planificaci√≥n',
                '‚úì Consulta por paquetes personalizados'
            ];

            let fechasFiltradas = [];
            let nombreDestino = '';
            
            if (destino === 'Chichiriviche' || destino === '1') {
                fechasFiltradas = filtrarFechasPorMes(fechasChichiriviche, mes);
                nombreDestino = 'CHICHIRIVICHE';
            } else if (destino === 'Mochima' || destino === '2') {
                fechasFiltradas = filtrarFechasPorMes(fechasMochima, mes);
                nombreDestino = 'MOCHIMA';
            } else if (destino === 'Tucacas' || destino === '3') {
                fechasFiltradas = filtrarFechasPorMes(fechasTucacas, mes);
                nombreDestino = 'TUCACAS';
            }

            if (fechasFiltradas.length > 0) {
                await flowDynamic([
                    `üìÖ *FECHAS ${nombreDestino} - ${mes.toUpperCase()}*\n\n` +
                    fechasFiltradas.join('\n') +
                    '\n\nüí¨ *¬øVas a reservar?* Di *reservar*'
                ]);
            } else {
                await flowDynamic([
                    `‚Ñπ No tenemos fechas programadas para ${nombreDestino} en ${mes}.`,
                    '',
                    'üí¨ Puedes escribir otro mes o *reservar* para contactar un asesor'
                ]);
            }
        }
    );

// FLUJO CHICHIRIVICHE
const flowChichiriviche = addKeyword(['Chichiriviche', '1'])
    .addAnswer([
        'üå¥ *PAQUETE CHICHIRIVICHE* (3-4 d√≠as)',
        '',
        'üìå *Incluye:*',
        '- üöå Bus cama con puestos asignados',
        '- ‚õµ Visita 4 o 3 playas:',
        '  ‚Ä¢ Cayo Sal',
        '  ‚Ä¢ Cayo Sombrero',
        '  ‚Ä¢ Varadero',
        '  ‚Ä¢ Cayo Muerto',
        '- üéâ Transporte en chiva rumbera',
        '- üè® Alojamiento con aire acondicionado',
        '- üçΩ Alimentaci√≥n completa',
        '',
        '¬øQu√© mes est√°s interesado en viajar? (Ejemplo: Agosto)'
    ])
    .addAction(
        { capture: true },
        async (ctx, { flowDynamic, gotoFlow, state }) => {
            await state.update({ destino: 'Chichiriviche' });
            const mes = ctx.body.toLowerCase();
            
            if (mes === 'reservar') {
                return gotoFlow(flowReservar);
            } else if (mes === 'informaci√≥n') {
                return gotoFlow(flowInfoAgencia);
            } else if (mes === 'hola') {
                return gotoFlow(flowPrincipal);
            } else {
                return gotoFlow(flowMes);
            }
        }
    );

// FLUJO MOCHIMA
const flowMochima = addKeyword(['Mochima', '2'])
    .addAnswer([
        'üèù *PAQUETE MOCHIMA* (5 d√≠as)',
        '',
        'üìå *Incluye:*',
        '- üöå Viaje en buses c√≥modos con aire acondicionado',
        '- üè® Habitaciones c√≥modas con aire acondicionado',
        '- ÔøΩ 3 comidas diarias incluidas',
        '- ‚õµ Visita a 4 playas espectaculares:',
        '  ‚Ä¢ La Gabarra',
        '  ‚Ä¢ Maritas',
        '  ‚Ä¢ Playa Blanca',
        '  ‚Ä¢ Manare',
        '- üéâ Recreaci√≥n personalizada',
        '- üèû Excursi√≥n al Parque Las Aguas de Mois√©s (Cariaco) con costo adicional de $10 por persona:',
        '  ‚Ä¢ Toboganes',
        '  ‚Ä¢ Pozos naturales',
        '  ‚Ä¢ Cascadas',
        '  ‚Ä¢ Y mucho m√°s',
        '',
        '¬øQu√© mes est√°s interesado en viajar? (Ejemplo: Agosto)'
    ])
    .addAction(
        { capture: true },
        async (ctx, { flowDynamic, gotoFlow, state }) => {
            await state.update({ destino: 'Mochima' });
            const mes = ctx.body.toLowerCase();
            
            if (mes === 'reservar') {
                return gotoFlow(flowReservar);
            } else if (mes === 'informaci√≥n') {
                return gotoFlow(flowInfoAgencia);
            } else if (mes === 'hola') {
                return gotoFlow(flowPrincipal);
            } else {
                return gotoFlow(flowMes);
            }
        }
    );

// FLUJO TUCACAS
const flowTucacas = addKeyword(['Tucacas', '3'])
    .addAnswer([
        'üåä *PAQUETE TUCACAS* (4 d√≠as/3 noches)',
        '',
        'üìå *Incluye:*',
        '- üöå Transporte ida y vuelta en bus ejecutivo con aire acondicionado',
        '- üè® Alojamiento en posada tur√≠stica (habitaciones dobles/triples con A/A)',
        '- üçΩÔ∏è Alimentaci√≥n completa (3 comidas diarias + snacks)',
        '- ‚õµ Excursiones a:',
        '  ‚Ä¢ Cayo Sombrero (2 d√≠as)',
        '  ‚Ä¢ Cayo Sal (1 d√≠a)',
        '  ‚Ä¢ Playas de Morrocoy (1 d√≠a)',
        '- ü§ø Equipo b√°sico de snorkel',
        '- üéâ Actividades recreativas y juegos en la playa',
        '- üö§ Transporte lacustre a todos los cayos',
        '- ÔøΩ‚Äç‚öïÔ∏è Asistencia m√©dica b√°sica',
        '',
        '¬øQu√© mes est√°s interesado en viajar? (Ejemplo: Agosto)'
    ])
    .addAction(
        { capture: true },
        async (ctx, { flowDynamic, gotoFlow, state }) => {
            await state.update({ destino: 'Tucacas' });
            const mes = ctx.body.toLowerCase();
            
            if (mes === 'reservar') {
                return gotoFlow(flowReservar);
            } else if (mes === 'informaci√≥n') {
                return gotoFlow(flowInfoAgencia);
            } else if (mes === 'hola') {
                return gotoFlow(flowPrincipal);
            } else {
                return gotoFlow(flowMes);
            }
        }
    );

// FLUJO FECHAS (ACTUALIZADO)
const flowFechas = addKeyword(['fechas', 'disponibilidad', 'cu√°ndo', 'fecha'])
    .addAnswer([
        'üìÖ *Consulta de Fechas Disponibles*',
        '',
        'Escribe el nombre del destino para ver sus fechas programadas:',
        'üèù *Chichiriviche*',
        'üèù *Mochima*',
        'üèù *Tucacas*',
        '',
        'O escribe *todas* para ver toda la programaci√≥n'
    ])
    .addAction(
        { capture: true },
        async (ctx, { gotoFlow, flowDynamic }) => {
            const destino = ctx.body.toLowerCase();
            
            // Fechas actualizadas
            const fechasChichiriviche = [
                '‚úì DEL 15 AL 19 MAYO 2025 (4D/3N CELEBRACI√ìN DE LAS MADRES)',
                '‚úì DEL 21 AL 25 MAYO 2025 (4D/3N PAQUETE LUISANA BOGOT√Å)',
                '‚úì DEL 05 AL 08 JUN 2025 (PROMO 3D/2N)',
                '‚úì DEL 26 AL 29 JUN 2025 (PROMO 3D/2N)',
                '‚úì DEL 19 AL 22 JUN 2025 (OCUMARE 3D/2N)',
                '‚úì DEL 03 AL 06 JUL 2025 (PROMO 3D/2N)',
                '‚úì DEL 17 AL 20 JUL 2025 (PROMO 3D/2N)',
                '‚úì DEL 20 AL 24 JUL 2025 (4D/3N)',
                '‚úì DEL 31 JUL AL 04 AGO 2025 (4D/3N)',
                '‚úì DEL 04 AL 08 AGO 2025 (4D/3N)',
                '‚úì DEL 08 AL 12 AGO 2025 (4D/3N)',
                '‚úì DEL 12 AL 15 AGO 2025 (PROMO 3D/2N)',
                '‚úì DEL 15 AL 19 AGO 2025 (4D/3N)',
                '‚úì DEL 29 AGO AL 02 SEP 2025 (4D/3N)',
                '‚úì DEL 12 AL 15 SEP 2025 (PROMO 3D/2N)',
                '‚úì DEL 16 AL 19 SEP 2025 (PROMO 3D/2N)',
                '‚úì DEL 19 AL 23 SEP 2025 (4D/3N)',
                '‚úì DEL 25 AL 28 SEP 2025 (PROMO 3D/2N)',
                '‚úì DEL 02 AL 05 OCT 2025 (PROMO 3D/2N)',
                '‚úì DEL 30 OCT AL 02 NOV 2025 (PROMO 3D/2N)',
                '‚úì DEL 06 AL 09 NOV 2025 (PROMO 3D/2N)',
                '‚úì DEL 27 AL 30 NOV 2025 (PROMO 3D/2N)',
                '‚úì DEL 11 AL 14 DIC 2025 (PROMO 3D/2N)',
                '‚úì DEL 22 AL 26 DIC 2025 (4D/3N)',
                '‚úì DEL 29 DIC AL 02 ENE 2026 (4D/3N)',
                '‚úì DEL 03 AL 07 ENE 2026 (4D/3N)'
            ];
            
            const fechasMochima = [
                '‚úì DEL 21 AL 27 AGO 2025 (5 D√çAS)',
                '‚úì DEL 05 AL 11 SEP 2025 (5 D√çAS)',
                '‚úì DEL 02 AL 08 ENE 2026 (5 D√çAS)'
            ];

            const fechasTucacas = [
                '‚úì Pr√≥ximas fechas en planificaci√≥n',
                '‚úì Consulta por paquetes personalizados'
            ];

            if (destino.includes('chichiriviche') || destino === '1') {
                await flowDynamic([
                    'üå¥ *TODAS LAS FECHAS CHICHIRIVICHE 2025-2026*\n\n' + 
                    fechasChichiriviche.join('\n') +
                    '\n\nüí¨ Escribe el *mes* que te interesa (ej: Agosto) o *reservar*'
                ]);
            }
            else if (destino.includes('mochima') || destino === '2') {
                await flowDynamic([
                    'üèù *TODAS LAS FECHAS MOCHIMA 2025-2026*\n\n' + 
                    fechasMochima.join('\n') +
                    '\n\nüí¨ Escribe el *mes* que te interesa o *reservar*'
                ]);
            }
            else if (destino.includes('tucacas') || destino === '3') {
                await flowDynamic([
                    'üåä *FECHAS TUCACAS*\n\n' + 
                    fechasTucacas.join('\n') +
                    '\n\nüí¨ Escribe *reservar* para contactar un asesor'
                ]);
            }
            else if (destino.includes('todas')) {
                await flowDynamic([
                    'üìÖ *TODAS LAS FECHAS VIGENTES 2025-2026*',
                    '',
                    'üå¥ *CHICHIRIVICHE:*\n' + fechasChichiriviche.join('\n'),
                    '',
                    'üèù *MOCHIMA:*\n' + fechasMochima.join('\n'),
                    '',
                    'üåä *TUCACAS:*\n' + fechasTucacas.join('\n'),
                    '',
                    'üìÖ Para reservar di *reservar*'
                ]);
            }
            else {
                await flowDynamic('‚ö†Ô∏è No reconozco ese destino. Por favor escribe: *Chichiriviche*, *Mochima* o *Tucacas*');
                return gotoFlow(flowFechas);
            }
        }
    );

// FLUJO PRINCIPAL
const flowPrincipal = addKeyword(['hola', 'buenos d√≠as', 'buenas', 'alo'])
    .addAnswer([
        '‚ú® ¬°Hola Viajero! ‚ú®',
        '*Soy Nenita*, tu bot asistente ü§ñ',
        '¬øEn qu√© puedo ayudarte? üòä',
        '',
        'Elige una opci√≥n:',
        '',
        'üèñ *Destinos:*',
        'üèù 1 Chichiriviche',
        'üèù 2 Mochima',
        'üèù 3 Tucacas',
        '',
        'üìÖ *Consultas:*',
        'üëâ *fechas* - Ver disponibilidad',
        'üëâ *reservar* - Iniciar reserva',
        '',
        '‚Ñπ *Informaci√≥n:*',
        'üëâ *informaci√≥n* - Sobre nuestra agencia'
    ], null, null, [flowChichiriviche, flowMochima, flowTucacas, flowInfoAgencia, flowFechas, flowReservar])

// MAIN FUNCTION
const main = async () => {
    const adapterDB = new MockAdapter()
    const adapterFlow = createFlow([
        flowPrincipal,
        flowInfoAgencia,
        flowChichiriviche,
        flowMochima,
        flowTucacas,
        flowReservar,
        flowFechas,
        flowMes,
        flowDefault
    ])
    const adapterProvider = createProvider(BaileysProvider)

    createBot({
        flow: adapterFlow,
        provider: adapterProvider,
        database: adapterDB,
    })

    QRPortalWeb()
}

main()